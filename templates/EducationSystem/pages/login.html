{% extends "EducationSystem/base.html" %} {% load static %} {% block content %}
<div class="center-box">
  <!-- ایکون دانشجو -->
  <div
    style="position: relative; width: 180px; margin: auto; margin-bottom: 30px"
  >
    <!-- عکس دایره (پس‌زمینه) -->
    <img
      src="{% static '/EducationSystem/images/Ellipse 1.png' %}"
      style="width: 180px; display: block; opacity: 0.9"
    />

    <!-- عکس دوم که داخل دایره قرار می‌گیرد -->
    <img
      src="{% static '/EducationSystem/images/education white 1.png' %}"
      style="
        width: 90px;
        height: 90px;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      "
    />
  </div>

  <form method="POST" id="loginForm" style="text-align: center">
    {% csrf_token %}

    <!-- مرحله ۱: شماره دانشجویی -->
    <div id="step1">
      <label style="font-size: 16px; font-weight: bold">
        لطفا شماره دانشجویی خود را وارد کنید:
      </label>
      <br />
      <input
        type="text"
        id="student_id"
        name="student_id"
        required
        autocomplete="off"
      />
    </div>

    <br />

    <!-- مرحله ۲: پسورد -->
    <div id="step2" style="display: none; opacity: 0; transition: opacity 0.4s">
      <label style="font-size: 16px; font-weight: bold">
        لطفا رمز عبور خود را وارد کنید:
      </label>
      <br />
      <input
        type="password"
        id="password"
        name="password"
        required
        autocomplete="off"
      />
    </div>

    <br /><br />

    <!-- دکمه ورود -->
    <button
      type="button"
      id="submitBtn"
      class="btn-primary-custom"
      style="display: none; opacity: 0; transition: opacity 0.4s"
    >
      ورود
    </button>

    <!-- Error message -->
    <div
      id="error-message"
      style="color: red; margin-top: 10px; display: none"
    ></div>
  </form>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const studentInput = document.getElementById("student_id");
    const passwordInput = document.getElementById("password");
    const step2 = document.getElementById("step2");
    const submitBtn = document.getElementById("submitBtn");

    studentInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        e.preventDefault();

        if (studentInput.value.trim() !== "") {
          step2.style.display = "block";
          setTimeout(() => (step2.style.opacity = "1"), 10);

          submitBtn.style.display = "inline-block";
          setTimeout(() => (submitBtn.style.opacity = "1"), 10);

          passwordInput.focus();
        }
      }
    });

    passwordInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        handleLogin();
      }
    });

    // AJAX login function
    function handleLogin() {
      const studentId = studentInput.value.trim();
      const password = passwordInput.value.trim();
      const errorMessage = document.getElementById("error-message");

      if (!studentId || !password) {
        errorMessage.textContent = "لطفا تمام فیلدها را پر کنید";
        errorMessage.style.display = "block";
        return;
      }

      // Show loading
      submitBtn.disabled = true;
      submitBtn.textContent = "در حال ورود...";
      errorMessage.style.display = "none";

      // AJAX call to login API
      fetch("/EducationSystem/api/auth/login/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
            .value,
        },
        body: JSON.stringify({
          studentId: studentId,
          password: password,
        }),
        credentials: "same-origin",
      })
        .then((response) => {
          if (!response.ok) {
            return response
              .json()
              .then((data) => {
                throw new Error(
                  data.detail ||
                    `خطا: ${response.status} ${response.statusText}`
                );
              })
              .catch(() => {
                throw new Error(`خطا در ارتباط با سرور: ${response.status}`);
              });
          }
          return response.json();
        })
        .then((data) => {
          if (data.token) {
            // Store token in localStorage (optional)
            localStorage.setItem("auth_token", data.token);

            // Redirect to dashboard
            window.location.href = "/EducationSystem/dashboard/";
          } else {
            throw new Error(data.detail || "خطا در ورود");
          }
        })
        .catch((error) => {
          console.error("Login error:", error);
          errorMessage.textContent =
            error.message || "نام کاربری یا رمز عبور اشتباه است";
          errorMessage.style.display = "block";
          submitBtn.disabled = false;
          submitBtn.textContent = "ورود";
        });
    }

    submitBtn.addEventListener("click", handleLogin);
  });
</script>

{% endblock %}
